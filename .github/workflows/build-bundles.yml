name: Build ferp bundles

on:
  repository_dispatch:
    types: ["scripts_push"]
  workflow_dispatch: {}

concurrency:
  group: ferp-bundles
  cancel-in-progress: false

jobs:
  bundle:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout ferp (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Force scripts submodule to dispatched SHA
        if: ${{ github.event_name == 'repository_dispatch' }}
        env:
          SCRIPTS_SHA: ${{ github.event.client_payload.scripts_sha }}
        run: |
          set -euo pipefail

          echo "Target scripts SHA: ${SCRIPTS_SHA}"

          cd ferp/scripts

          # Ensure we can fetch the exact commit.
          git fetch --no-tags origin "${SCRIPTS_SHA}" --depth=1
          git checkout --detach "${SCRIPTS_SHA}"

          echo "Pinned submodule to: $(git rev-parse HEAD)"

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install ferp (and UI deps)
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          python -m pip install . textual

      - name: Build bundles (only changed dirs; duplicate readmes)
        shell: bash
        env:
          # May be empty for workflow_dispatch; handled below.
          CHANGED_DIRS_JSON: ${{ toJson(github.event.client_payload.changed_dirs) }}
        run: |
          set -euo pipefail

          rm -rf dist
          mkdir -p dist

          # Determine which script directories to build.
          # For repository_dispatch: use payload changed_dirs
          # For workflow_dispatch (manual): build all directories (fallback).
          changed_dirs=""
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            # Normalize JSON input from Actions; toJson(null) can become "null"
            raw="${CHANGED_DIRS_JSON:-[]}"
            echo "CHANGED_DIRS_JSON(raw)=$raw"
            
            if [ "$raw" = "null" ] || [ -z "$raw" ]; then
              raw="[]"
            fi

            changed_dirs="$(python -c 'import json,sys; data=json.loads(sys.argv[1]); print("\n".join([d.strip() for d in data if isinstance(d,str) and d.strip()]))' "$raw")"

            if [ -z "$changed_dirs" ]; then
              echo "No changed script directories detected; nothing to bundle."
              exit 0
            fi
            echo "Changed dirs to bundle:"
            echo "$changed_dirs"
          else
            echo "Manual run: bundling all scripts."
            changed_dirs="$(ls -1 ferp/scripts 2>/dev/null || true)"
          fi

          shopt -s nullglob
          while IFS= read -r base; do
            [ -n "$base" ] || continue

            d="ferp/scripts/$base"
            if [ ! -d "$d" ]; then
              echo "Skipping missing directory: $d"
              continue
            fi

            # Require README
            readme="$d/readme.md"
            if [ ! -f "$readme" ]; then
              echo "ERROR: Missing required readme.md in $d" >&2
              exit 1
            fi

            # Require script entrypoint
            script="$d/script.py"
            if [ ! -f "$script" ]; then
              echo "ERROR: Missing required script.py in $d" >&2
              exit 1
            fi

            # If directory name is "ferp.hello_world", output should be "hello_world"
            name="$base"
            if [[ "$name" == ferp.* ]]; then
              name="${name#ferp.}"
            fi

            out_dir="dist/$name"
            mkdir -p "$out_dir"

            python -m ferp.cli bundle "$script" "$readme" -o "$out_dir/$name.ferp"

            # Ensure bundle was created (fail fast)
            test -f "$out_dir/$name.ferp" || { echo "ERROR: bundle not created at $out_dir/$name.ferp"; exit 1; }

            # Duplicate README for end-user browsing
            cp "$readme" "$out_dir/readme.md"

          done <<< "$changed_dirs"

          echo "Built bundles:"
          find dist -maxdepth 2 -type f -print

      - name: Checkout bundle repo
        uses: actions/checkout@v4
        with:
          repository: zappbrandigan/ferp-script-bundles
          token: ${{ secrets.BUNDLE_PUBLISH_TOKEN }}
          path: bundle-repo
          persist-credentials: true

      - name: Publish bundles (incremental; no auto-removal)
        shell: bash
        run: |
          set -euo pipefail

          # Incremental publish: do NOT delete existing bundles not rebuilt.
          # Also protect .git.
          rsync -av --exclude '.git/' dist/ bundle-repo/

          cd bundle-repo
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add -A
          if git diff --cached --quiet; then
            echo "No changes"
            exit 0
          fi

          git commit -m "Update ferp bundles"
          git push
